<div class="player-page">
  <!-- Continue Watching Banner -->
  <div *ngIf="showContinueWatching && savedProgress" class="continue-banner">
    <div class="continue-content">
      <div class="continue-icon">
        <i class="fas fa-history"></i>
      </div>
      <div class="continue-info">
        <h3>Continue Watching?</h3>
        <p *ngIf="mediaType === 'tv'">
          Last watched: <span class="highlight">{{ savedProgress.seasonName }}</span>
        </p>
        <p *ngIf="mediaType === 'movie' && savedProgress.progress">
          Progress: <span class="highlight">{{ formatTime(savedProgress.progress) }} / {{ formatTime(savedProgress.duration) }}</span>
        </p>
      </div>
      <div class="continue-actions">
        <button class="btn-primary" (click)="continueWatching()">
          <i class="fas fa-play"></i> Continue
        </button>
        <button class="btn-secondary" (click)="startFromBeginning()">
          <i class="fas fa-redo"></i> Start Over
        </button>
      </div>
    </div>
  </div>

  <!-- Video Player -->
  <div class="player-wrapper">
    <div class="player-container">
      <iframe #videoIframe
              *ngIf="trustedVideoUrl"
              [src]="trustedVideoUrl"
              frameborder="0"
              allowfullscreen
              allow="autoplay; encrypted-media">
      </iframe>
      <div *ngIf="!trustedVideoUrl" class="no-video-state">
        <i class="fas fa-video-slash"></i>
        <p>No video available</p>
      </div>
      
      <!-- Current Episode Badge (for TV shows) -->
      <div *ngIf="mediaType === 'tv'" class="current-episode-badge">
        <span class="episode-label">Now Playing</span>
        <span class="episode-info">S{{ season }}:E{{ episode < 10 ? '0' + episode : episode }}</span>
      </div>
      
      <!-- Episode Navigation Buttons (for TV shows) -->
      <div *ngIf="mediaType === 'tv'" class="episode-nav-buttons">
        <button 
          class="episode-nav-btn prev" 
          (click)="playPreviousEpisode()" 
          [disabled]="!hasPreviousEpisode()"
          title="Previous Episode">
          <i class="fas fa-chevron-left"></i>
          <span>Previous</span>
        </button>
        <button 
          class="episode-nav-btn next" 
          (click)="playNextEpisode()" 
          [disabled]="!hasNextEpisode()"
          title="Next Episode">
          <span>Next</span>
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
      
      <!-- Next Episode Overlay -->
      <div *ngIf="showNextEpisode" class="next-episode-overlay">
        <button class="close-next" (click)="cancelNextEpisode()">
          <i class="fas fa-times"></i>
        </button>
        <div class="next-episode-card">
          <div class="next-icon">
            <i class="fas fa-play-circle"></i>
          </div>
          <div class="next-info">
            <h4>Next Episode</h4>
            <p class="episode-number">
              <ng-container *ngIf="episode < totalEpisodesInSeason">
                S{{ season }}:E{{ (episode + 1) < 10 ? '0' + (episode + 1) : (episode + 1) }}
              </ng-container>
              <ng-container *ngIf="episode >= totalEpisodesInSeason && season < totalSeasons">
                S{{ season + 1 }}:E01
              </ng-container>
            </p>
            <p class="countdown">Playing in <span>{{ nextEpisodeCountdown }}s</span></p>
          </div>
          <button class="btn-play-next" (click)="playNextEpisode()">
            <i class="fas fa-play"></i> Play Now
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Controls Section -->
  <div class="player-controls" *ngIf="mediaType === 'tv'">
    <div class="view-toggle">
      <button class="toggle-btn" [class.active]="showDetails" (click)="showDetails = true">
        <i class="fas fa-info-circle"></i>
        <span>Details</span>
      </button>
      <button class="toggle-btn" [class.active]="!showDetails" (click)="showDetails = false">
        <i class="fas fa-list"></i>
        <span>Episodes</span>
      </button>
    </div>
  </div>

  <!-- Episodes Section -->
  <div *ngIf="mediaType === 'tv' && !showDetails && mediaDetails" class="episodes-section">
    <div class="episodes-header">
      <h2><i class="fas fa-list"></i> Episodes</h2>
      <div class="season-selector">
        <label for="season-select">Season</label>
        <select id="season-select" [(ngModel)]="season" (change)="onSeasonChange(season)">
          <option *ngFor="let s of allSeasons" [value]="s">{{ s }}</option>
        </select>
      </div>
    </div>
    
    <div class="episodes-grid" *ngIf="seasonDetails && !loadingEpisodes">
      <div class="episode-card" 
           *ngFor="let ep of seasonDetails.episodes" 
           (click)="playEpisode(ep.episode_number)"
           [class.active]="ep.episode_number === episode"
           [class.current-playing]="ep.episode_number === episode">
        <div class="episode-thumbnail">
          <img [src]="getEpisodeThumbnail(ep)" alt="Episode {{ ep.episode_number }}">
          <div class="episode-overlay">
            <div class="play-icon">
              <i class="fas" [class.fa-play]="ep.episode_number !== episode" [class.fa-pause]="ep.episode_number === episode"></i>
            </div>
          </div>
          <div class="episode-number-badge">{{ ep.episode_number }}</div>
          <div *ngIf="ep.episode_number === episode" class="current-playing-indicator">
            <i class="fas fa-circle"></i>
            <span>Now Playing</span>
          </div>
        </div>
        <div class="episode-info">
          <h4>{{ ep.name }}</h4>
          <p class="episode-meta">
            <span>{{ ep.runtime ? ep.runtime + ' min' : '' }}</span>
            <span *ngIf="ep.vote_average"><i class="fas fa-star"></i> {{ ep.vote_average | number:'1.1-1' }}</span>
          </p>
        </div>
      </div>
    </div>
    
    <div *ngIf="loadingEpisodes" class="loading-state">
      <div class="spinner"></div>
      <p>Loading episodes...</p>
    </div>
  </div>

  <!-- Details Section (for TV shows when details tab is active) -->
  <div *ngIf="mediaType === 'tv' && showDetails && mediaDetails" class="details-section">
    <div class="details-content">
      <div class="details-poster">
        <img [src]="getPosterUrl(mediaDetails.poster_path)" [alt]="mediaDetails.name">
      </div>
      <div class="details-info">
        <h1>{{ mediaDetails.name }}</h1>
        <div class="details-meta">
          <span class="badge"><i class="fas fa-star"></i> {{ mediaDetails.vote_average | number:'1.1-1' }}</span>
          <span class="badge">{{ mediaDetails.first_air_date | date:'yyyy' }}</span>
          <span class="badge">{{ totalSeasons }} {{ totalSeasons === 1 ? 'Season' : 'Seasons' }}</span>
          <span class="badge" *ngIf="mediaDetails.status">{{ mediaDetails.status }}</span>
        </div>
        <p class="overview">{{ mediaDetails.overview }}</p>
        <div class="genres">
          <span class="genre-tag" *ngFor="let genre of mediaDetails.genres">{{ genre.name }}</span>
        </div>
        
        <!-- Action Buttons -->
        <div class="action-buttons">
          <button class="action-btn" [class.active]="isFavorite" (click)="toggleFavorite()" title="Add to Favorites">
            <i class="fas fa-heart" *ngIf="isFavorite"></i>
            <i class="far fa-heart" *ngIf="!isFavorite"></i>
            <span>{{ isFavorite ? 'Favorited' : 'Favorite' }}</span>
          </button>
          <button class="action-btn" (click)="openRatingModal()" title="Rate this show">
            <i class="fas fa-star"></i>
            <span>{{ userRating > 0 ? 'Rated ' + userRating + '/5' : 'Rate' }}</span>
          </button>
          <button class="action-btn" (click)="openListModal()" title="Add to List">
            <i class="fas fa-plus"></i>
            <span>Add to List</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Movie Details (for movies) -->
  <div *ngIf="mediaType === 'movie' && mediaDetails" class="details-section">
    <div class="details-content">
      <div class="details-poster">
        <img [src]="getPosterUrl(mediaDetails.poster_path)" [alt]="mediaDetails.title">
      </div>
      <div class="details-info">
        <h1>{{ mediaDetails.title }}</h1>
        <div class="details-meta">
          <span class="badge"><i class="fas fa-star"></i> {{ mediaDetails.vote_average | number:'1.1-1' }}</span>
          <span class="badge">{{ mediaDetails.release_date | date:'yyyy' }}</span>
          <span class="badge" *ngIf="mediaDetails.runtime">{{ mediaDetails.runtime }} min</span>
          <span class="badge" *ngIf="mediaDetails.status">{{ mediaDetails.status }}</span>
        </div>
        <p class="overview">{{ mediaDetails.overview }}</p>
        <div class="genres">
          <span class="genre-tag" *ngFor="let genre of mediaDetails.genres">{{ genre.name }}</span>
        </div>
        
        <!-- Action Buttons -->
        <div class="action-buttons">
          <button class="action-btn" [class.active]="isFavorite" (click)="toggleFavorite()" title="Add to Favorites">
            <i class="fas fa-heart" *ngIf="isFavorite"></i>
            <i class="far fa-heart" *ngIf="!isFavorite"></i>
            <span>{{ isFavorite ? 'Favorited' : 'Favorite' }}</span>
          </button>
          <button class="action-btn" (click)="openRatingModal()" title="Rate this movie">
            <i class="fas fa-star"></i>
            <span>{{ userRating > 0 ? 'Rated ' + userRating + '/5' : 'Rate' }}</span>
          </button>
          <button class="action-btn" (click)="openListModal()" title="Add to List">
            <i class="fas fa-plus"></i>
            <span>Add to List</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Rating Modal -->
  <div class="modal-overlay" *ngIf="showRatingModal" (click)="closeRatingModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Rate {{ mediaDetails?.title || mediaDetails?.name }}</h3>
        <button class="close-btn" (click)="closeRatingModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <p class="rating-prompt">How would you rate this {{ mediaType === 'movie' ? 'movie' : 'show' }}?</p>
        <app-rating-stars
          [currentRating]="userRating"
          [readonly]="false"
          (ratingChange)="onRatingChange($event)">
        </app-rating-stars>
      </div>
    </div>
  </div>

  <!-- List Selection Modal -->
  <div class="modal-overlay" *ngIf="showListModal" (click)="closeListModal()">
    <div class="modal-content list-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Add to List</h3>
        <button class="close-btn" (click)="closeListModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="list-selection">
          <div *ngIf="userLists.length === 0" class="empty-state">
            <i class="fas fa-layer-group"></i>
            <p>No lists yet. Create one below!</p>
          </div>
          
          <div *ngIf="userLists.length > 0" class="lists-grid">
            <div *ngFor="let list of userLists" 
                 class="list-option"
                 [class.selected]="isListSelected(list.id)"
                 (click)="toggleListSelection(list.id)">
              <i class="fas" [class.fa-check-circle]="isListSelected(list.id)" [class.fa-circle]="!isListSelected(list.id)"></i>
              <div class="list-info">
                <span class="list-title">{{ list.title }}</span>
                <span class="list-count">{{ list.movies?.length || 0 }} movies</span>
              </div>
            </div>
          </div>
          
          <button class="btn-new-list" (click)="toggleNewListForm()">
            <i class="fas fa-plus"></i>
            {{ showNewListForm ? 'Cancel' : 'Create New List' }}
          </button>
          
          <div *ngIf="showNewListForm" class="new-list-form">
            <input 
              type="text" 
              [(ngModel)]="newListTitle" 
              placeholder="Enter list name..."
              class="list-input"
              (keyup.enter)="createNewList()">
            <button class="btn-create" (click)="createNewList()" [disabled]="!newListTitle.trim()">
              <i class="fas fa-check"></i>
              Create
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeListModal()">Cancel</button>
        <button class="btn-add" (click)="addToSelectedLists()" [disabled]="selectedListIds.length === 0">
          Add to {{ selectedListIds.length }} {{ selectedListIds.length === 1 ? 'List' : 'Lists' }}
        </button>
      </div>
    </div>
  </div>
</div>
